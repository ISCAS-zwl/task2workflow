# Phase 1: 参数覆盖功能使用指南

## 功能概述

Phase 1 实现了**节点参数覆盖**功能，允许用户在工作流规划完成后，手动修改节点参数并重新执行，而无需重新规划整个工作流。

## 核心特性

- ✅ **无需重新规划**：修改参数后直接执行，节省 LLM 调用成本
- ✅ **支持所有节点类型**：LLM 节点、工具节点、param_guard 节点
- ✅ **双模式编辑**：表单模式 + JSON 模式
- ✅ **实时预览**：已编辑节点高亮显示，显示 ✓ 标记
- ✅ **批量修改**：可以修改多个节点后一次性应用

## 使用流程

### 1. 执行工作流规划

1. 输入任务描述（如："查询北京的天气"）
2. 点击**"开始执行"**
3. 等待工作流规划完成

### 2. 进入编辑模式

1. 规划完成后，点击顶部的**"编辑工作流"**按钮
2. 按钮变为激活状态（蓝色高亮），显示"编辑中"
3. DAG 图中的节点现在可以点击编辑

### 3. 编辑节点参数

#### 方式 1：表单模式（推荐）

1. 点击 DAG 图中的任意节点
2. 弹出编辑对话框（默认表单模式）
3. 直接修改参数值
4. 点击"保存修改"

**示例**：
```
原参数：
  city: 北京

修改为：
  city: 上海
```

#### 方式 2：JSON 模式（高级）

1. 点击节点后，在对话框中切换到"JSON 模式"
2. 直接编辑 JSON 内容
3. 实时语法检查，错误会高亮提示
4. 点击"保存修改"

**示例**：
```json
{
  "city": "上海",
  "date": "2025-12-10"
}
```

### 4. 应用修改并执行

1. 修改完所有需要修改的节点
2. 点击**"应用修改 (N)"**按钮（显示修改的节点数量）
3. 确认提示框
4. 工作流将使用**原任务 + 新参数**重新执行

⚠️ **重要**：
- **"应用修改"** = 重新执行上次的任务（使用新参数）
- **"开始执行"** = 执行输入框中的任务（忽略参数修改）

### 5. 查看执行结果

- 已编辑的节点在 DAG 图中显示黄色边框和 ✓ 标记
- 执行过程正常显示
- 最终结果反映新参数的影响

## 支持的节点类型

### LLM 节点

**可编辑参数**：
- `prompt`: 提示词内容
- 其他 input 字段

**注意**：
- 如果参数包含引用（如 `{ST1.output}`），修改后引用仍然有效
- 建议保留引用语法，只修改固定部分

### 工具节点

**可编辑参数**：
- 工具的所有输入参数（如 `city`, `url`, `file_path` 等）

**注意**：
- 如果节点前有 `param_guard` 节点，覆盖会在 guard 之后应用
- 确保参数符合工具的 schema 要求

### Param Guard 节点

**可编辑参数**：
- `target_input_template`: 目标工具的输入模板

**注意**：
- 修改 guard 节点会影响下游工具节点
- 通常不建议修改 guard 节点，直接修改工具节点更简单

## 界面元素说明

### 编辑模式按钮

```
[编辑工作流]  ← 未激活（灰色）
[编辑中]      ← 已激活（蓝色）
```

**状态**：
- 禁用：工作流正在规划/执行中
- 启用：工作流规划完成且未执行

### 应用修改按钮

```
[应用修改 (3)]  ← 显示已修改节点数量
```

**行为**：
- 点击后弹出确认框
- 确认后自动执行工作流
- 执行完成后编辑模式自动关闭

### 节点状态标识

```
┌─────────────────┐
│ TOOL    ST1  ✓  │  ← ✓ 表示已编辑
└─────────────────┘
   ↑ 黄色边框
```

## 重要概念：两种执行模式

### 模式 1：执行新任务（"开始执行"按钮）

```
1. 修改任务输入框 → "帮我查询上海的天气"
2. 点击"开始执行"
3. 结果：LLM 重新规划工作流，参数覆盖被清空
```

**适用场景**：想执行全新的任务

### 模式 2：应用参数修改（"应用修改"按钮）

```
1. 保持原任务输入框不变 → "帮我查询北京的天气"
2. 编辑节点参数 → city: "上海"
3. 点击"应用修改 (1)"
4. 结果：使用原工作流 + 新参数，查询上海天气
```

**适用场景**：微调工作流参数，避免重新规划

### 🎯 核心区别

| 按钮 | 任务来源 | 参数来源 | 是否重新规划 |
|------|---------|---------|------------|
| **开始执行** | 输入框 | LLM 规划 | ✅ 是 |
| **应用修改** | 上次执行 | 用户编辑 | ❌ 否 |

### 防误操作提示

如果你编辑了参数，然后修改任务输入框并点击"开始执行"，系统会弹窗提示：

```
检测到任务输入已变化，将丢弃 3 个参数修改。

如需应用参数修改，请使用"应用修改"按钮。

是否继续执行新任务？
```

这样避免意外丢失参数修改。

---

## 限制和注意事项

### 当前限制

1. **不能修改 DAG 结构**：
   - 不能添加/删除节点
   - 不能修改连接关系
   - 只能修改节点参数

2. **执行中不能编辑**：
   - 工作流执行时编辑按钮禁用
   - 需要等待执行完成或手动停止

3. **不支持撤销**：
   - 修改后没有撤销功能
   - 建议重要参数先记录原值

4. **参数覆盖仅用于重新执行**：
   - 修改参数后必须点击"应用修改"
   - 点击"开始执行"会执行新任务（忽略参数修改）

### 最佳实践

1. **小步快跑**：
   - 修改 1-2 个节点后立即测试
   - 避免一次修改过多节点

2. **验证参数**：
   - JSON 模式下注意语法错误
   - 表单模式更不容易出错

3. **保存工作流**：
   - 重要的工作流可以复制 WorkflowIR JSON
   - 下次可以直接加载（Phase 2 功能）

## 故障排除

### 问题 1：点击节点无反应

**原因**：未进入编辑模式

**解决**：点击"编辑工作流"按钮

---

### 问题 2：应用修改按钮不显示

**原因**：没有修改任何节点参数

**解决**：至少编辑一个节点

---

### 问题 3：JSON 语法错误无法保存

**原因**：JSON 格式不正确

**解决**：
- 检查括号、引号是否配对
- 使用 JSON 验证工具检查
- 切换到表单模式编辑

---

### 问题 4：修改后执行结果未变化

**原因**：
- 参数覆盖未生效
- 节点被 guard 节点影响

**解决**：
- 检查后端日志，确认参数覆盖已应用
- 尝试修改下游工具节点而非 guard 节点

---

### 问题 5：点击"开始执行"后参数修改消失

**原因**：点击了"开始执行"而不是"应用修改"

**解决**：
- 参数修改后应该点击**"应用修改 (N)"**按钮
- "开始执行"用于执行新任务，会忽略参数修改

---

### 问题 6：弹窗提示"没有可重新执行的工作流"

**原因**：首次打开页面，还没有执行过任务

**解决**：
- 先执行一次任务
- 然后再编辑参数

## 技术细节

### 数据流

```
用户编辑参数
    ↓
前端收集 paramOverrides = {"ST1": {...}, "ST2": {...}}
    ↓
发送到后端: { type: "start", param_overrides: {...} }
    ↓
后端应用覆盖: apply_param_overrides(workflow_ir, param_overrides)
    ↓
执行工作流（使用新参数）
```

### 后端 API

**WebSocket 消息格式**：
```json
{
  "type": "start",
  "task": "查询天气",
  "param_overrides": {
    "ST1": {"city": "上海"},
    "ST2": {"format": "json"}
  }
}
```

### 前端状态

```javascript
// App.jsx
const [editMode, setEditMode] = useState(false)
const [paramOverrides, setParamOverrides] = useState({
  "ST1": {"city": "上海"}
})
```

## 下一步（Phase 2）

Phase 2 将支持完整的工作流编辑：
- ✨ 添加/删除节点
- ✨ 修改连接关系
- ✨ 工作流模板保存/加载
- ✨ 版本管理

敬请期待！

---

**文档版本**: 1.0  
**最后更新**: 2025-12-10  
**反馈**: 如有问题或建议，请提交 issue
